<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivative Limit Visualizer</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #2563eb; --secant: #9333ea; --tangent: #dc2626;
            --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .container {
            max-width: 1100px; width: 100%; display: grid; 
            grid-template-columns: 1fr 340px; gap: 20px;
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
        h1 { grid-column: 1 / -1; margin: 0 0 15px 0; font-size: 1.6rem; text-align: center; color: var(--primary); }
        .graph-area { height: 500px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .controls { display: flex; flex-direction: column; gap: 18px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-weight: 600; font-size: 0.95rem; }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; }
        input[type="range"] { touch-action: none; cursor: pointer; width: 100%; }
        .animate-btn { background-color: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .stats, .formula-box { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .formula-box { 
            margin-top: 5px; 
            min-height: 85px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s ease;
            background: #ffffff;
        }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #cbd5e1; }
        .stat-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .stat-label { color: #64748b; font-size: 0.85rem; }
        .stat-value { font-family: monospace; font-weight: bold; }
        .legend-marker { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .error-msg { color: #dc2626; font-size: 0.8rem; min-height: 1.2em; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Derivative Limit Visualizer</h1>
        <div id="plot" class="graph-area"></div>
        <div class="controls">
            <div class="control-group">
                <label for="functionInput">Function f(x)</label>
                <input type="text" id="functionInput" value="x^2">
                <div id="errorMsg" class="error-msg"></div>
            </div>
            <div class="control-group">
                <label for="xValue">Point P (x value)</label>
                <input type="number" id="xValue" value="1" step="0.1">
            </div>
            <div class="control-group">
                <label>Distance h: <span id="hDisplay" style="font-family:monospace">1.00</span></label>
                <input type="range" id="hSlider" min="-3" max="3" step="0.01" value="1">
                <button class="animate-btn" onclick="animateLimit()">Animate h â†’ 0</button>
            </div>
            
            <div class="stats">
                <div id="secantRow" class="stat-row">
                    <span class="stat-label"><span class="legend-marker" style="background:var(--secant)"></span>Secant Slope (m<sub>sec</sub>)</span>
                    <span class="stat-value" id="secantSlope">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label"><span class="legend-marker" style="background:var(--tangent)"></span>Tangent Slope (f'(x))</span>
                    <span class="stat-value" id="tangentSlope">--</span>
                </div>
            </div>

            <div id="formulaBox" class="formula-box">
                <div id="mathContent">$$m_{sec} = \frac{f(x+h) - f(x)}{h}$$</div>
            </div>
        </div>
    </div>

    <script>
        const plotDiv = document.getElementById('plot');
        const functionInput = document.getElementById('functionInput');
        const xInput = document.getElementById('xValue');
        const hSlider = document.getElementById('hSlider');
        const hDisplay = document.getElementById('hDisplay');
        const secantSlopeDisp = document.getElementById('secantSlope');
        const tangentSlopeDisp = document.getElementById('tangentSlope');
        const mathContent = document.getElementById('mathContent');
        const formulaBox = document.getElementById('formulaBox');
        const secantRow = document.getElementById('secantRow');
        const errorMsg = document.getElementById('errorMsg');

        let globalXRange = [-3, 5];
        let globalYRange = [-5, 15];
        let currentFormulaMode = 'secant';

        function calculateNewWindow() {
            try {
                const funcStr = functionInput.value;
                const xVal = parseFloat(xInput.value);
                const node = math.parse(funcStr);
                const code = node.compile();
                globalXRange = [xVal - 4, xVal + 4];
                let yValues = [];
                for (let x = globalXRange[0]; x <= globalXRange[1]; x += 0.1) {
                    try {
                        const y = code.evaluate({x: x});
                        if (typeof y === 'number' && isFinite(y)) yValues.push(y);
                    } catch(e) {}
                }
                if (yValues.length > 0) {
                    const min = Math.min(...yValues);
                    const max = Math.max(...yValues);
                    const padding = (max - min) * 0.25 || 5;
                    globalYRange = [min - padding, max + padding];
                }
                updateGraph();
            } catch (e) { errorMsg.textContent = "Invalid function syntax"; }
        }

        function updateGraph() {
            try {
                const funcStr = functionInput.value;
                const xVal = parseFloat(xInput.value);
                const hVal = parseFloat(hSlider.value);
                const isLimitReached = Math.abs(hVal) < 0.02;

                const node = math.parse(funcStr);
                const code = node.compile();
                const yP = code.evaluate({x: xVal});
                const deriv = math.derivative(funcStr, 'x');
                const tSlope = deriv.evaluate({x: xVal});

                const xQ = xVal + hVal;
                const yQ = code.evaluate({x: xQ});
                const sSlope = (yQ - yP) / (hVal || 0.0001);

                hDisplay.textContent = hVal.toFixed(3);
                tangentSlopeDisp.textContent = tSlope.toFixed(4);
                
                const newMode = isLimitReached ? 'tangent' : 'secant';
                if (newMode !== currentFormulaMode) {
                    currentFormulaMode = newMode;
                    if (isLimitReached) {
                        mathContent.innerHTML = `$$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$`;
                        formulaBox.style.border = "2px solid var(--tangent)";
                    } else {
                        mathContent.innerHTML = `$$m_{sec} = \\frac{f(x+h) - f(x)}{h}$$`;
                        formulaBox.style.border = "2px solid var(--secant)";
                    }
                    if (window.MathJax) MathJax.typesetPromise([mathContent]);
                }

                if (isLimitReached) {
                    secantSlopeDisp.textContent = "Limit Reached";
                    secantRow.style.opacity = "0.2";
                } else {
                    secantSlopeDisp.textContent = sSlope.toFixed(4);
                    secantRow.style.opacity = "1";
                }

                const xCurve = [], yCurve = [];
                for(let x = globalXRange[0]; x <= globalXRange[1]; x += 0.05) {
                    xCurve.push(x);
                    try { yCurve.push(code.evaluate({x: x})); } catch(e) { yCurve.push(null); }
                }

                const traces = [
                    { x: xCurve, y: yCurve, mode: 'lines', line: { color: '#1e293b', width: 2.5 }, name: 'f(x)', showlegend: true },
                    { x: globalXRange, y: globalXRange.map(x => tSlope * (x - xVal) + yP), mode: 'lines', line: { color: '#dc2626', width: 2, dash: 'dash' }, name: "Tangent Line f'(x)", showlegend: true }
                ];

                if (!isLimitReached) {
                    traces.push({ x: globalXRange, y: globalXRange.map(x => sSlope * (x - xVal) + yP), mode: 'lines', line: { color: '#9333ea', width: 2 }, name: 'Secant Line', showlegend: true });
                    traces.push({ x: [xVal, xQ], y: [yP, yQ], mode: 'markers+text', text: ['P', 'Q'], textposition: 'top center', marker: { size: 10, color: ['#1e293b', '#9333ea'] }, showlegend: false });
                } else {
                    traces.push({ x: [xVal], y: [yP], mode: 'markers+text', text: ['P'], textposition: 'top center', marker: { size: 12, color: '#1e293b' }, showlegend: false });
                }

                Plotly.react(plotDiv, traces, { 
                    xaxis: { range: globalXRange, zeroline: true, fixedrange: true }, 
                    yaxis: { range: globalYRange, zeroline: true, fixedrange: true },
                    margin: { t: 30, r: 150, b: 40, l: 40 },
                    showlegend: true,
                    legend: { x: 1.05, y: 1, xanchor: 'left' },
                    hovermode: false
                });
                errorMsg.textContent = "";
            } catch (err) { }
        }

        function animateLimit() {
            let currentH = parseFloat(hSlider.value);
            const interval = setInterval(() => {
                const step = currentH > 0 ? -0.05 : 0.05;
                currentH += step;
                if (Math.abs(currentH) < 0.05) { hSlider.value = 0; updateGraph(); clearInterval(interval); }
                else { hSlider.value = currentH; updateGraph(); }
            }, 16);
        }

        functionInput.addEventListener('input', calculateNewWindow);
        xInput.addEventListener('input', calculateNewWindow);
        hSlider.addEventListener('input', updateGraph);
        window.onload = calculateNewWindow;
    </script>
</body>
</html>
